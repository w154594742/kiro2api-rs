<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiro-RS Terminal Console</title>
    <link rel="icon" type="image/svg+xml" href="/assets/icon.svg">
    <style>
        @font-face {
            font-family: 'FusionPixel';
            src: url('/assets/fonts/fusion-pixel-12px-monospaced-zh_hans.woff2') format('woff2'),
                url('https://fusion-pixel-font.takwolf.com/fusion-pixel-12px-monospaced-zh_hans.otf.woff2') format('woff2');
            font-display: swap;
        }

        :root {
            --bg: #0b0a09;
            --bg-elev: #13110d;
            --panel: #17140f;
            --panel-2: #1d1811;
            --amber: #ffb347;
            --amber-dim: #cc8b2f;
            --amber-glow: rgba(255, 179, 71, 0.26);
            --ok: #57d38c;
            --warn: #ffd166;
            --err: #ff6b6b;
            --text: #f4d19b;
            --text-dim: #b99258;
            --grid-line: rgba(255, 179, 71, 0.08);
            --border: rgba(255, 179, 71, 0.38);
            --border-strong: rgba(255, 179, 71, 0.72);
            --shadow: 0 0 0 1px rgba(255, 179, 71, 0.1), 0 20px 40px rgba(0, 0, 0, 0.45);
            --radius: 4px;
            --font-main: 'FusionPixel', 'Noto Sans Mono CJK SC', 'Sarasa Mono SC', 'PingFang SC', 'Microsoft YaHei', monospace;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html,
        body {
            min-height: 100%;
        }

        body {
            font-family: var(--font-main);
            color: var(--text);
            background-color: var(--bg);
            background-image:
                linear-gradient(var(--grid-line) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-line) 1px, transparent 1px),
                radial-gradient(circle at 50% 0%, rgba(255, 179, 71, 0.08), transparent 45%),
                linear-gradient(180deg, #0f0d0a 0%, #090806 100%);
            background-size: 22px 22px, 22px 22px, 100% 100%, 100% 100%;
            padding: 20px;
            overflow-x: hidden;
            image-rendering: pixelated;
            letter-spacing: 0.02em;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            background: repeating-linear-gradient(to bottom,
                    rgba(0, 0, 0, 0.18) 0,
                    rgba(0, 0, 0, 0.18) 1px,
                    transparent 2px,
                    transparent 4px);
            opacity: 0.45;
            mix-blend-mode: multiply;
            z-index: 1;
        }

        .container,
        .login-container,
        .toast-root {
            position: relative;
            z-index: 2;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            animation: bootFade 280ms steps(8, end);
        }

        h1,
        h2,
        h3 {
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        h1 {
            color: var(--amber);
            font-size: 28px;
            text-shadow: 0 0 14px var(--amber-glow);
        }

        h2 {
            font-size: 15px;
            color: var(--text);
            margin-bottom: 12px;
        }

        h3 {
            font-size: 13px;
            color: var(--amber);
            margin-bottom: 12px;
        }

        .surface {
            background: linear-gradient(180deg, rgba(255, 179, 71, 0.06), transparent 18%), var(--panel);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .window-frame {
            padding: 18px;
            margin-bottom: 16px;
        }

        .window-titlebar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 12px;
        }

        .title-left {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }

        .signal {
            display: inline-flex;
            gap: 4px;
            align-items: flex-end;
            min-width: 28px;
        }

        .signal span {
            display: block;
            width: 5px;
            background: var(--amber);
            box-shadow: 0 0 8px var(--amber-glow);
            animation: signalPulse 1.8s steps(2, end) infinite;
        }

        .signal span:nth-child(1) {
            height: 6px;
            animation-delay: 0s;
        }

        .signal span:nth-child(2) {
            height: 10px;
            animation-delay: 0.25s;
        }

        .signal span:nth-child(3) {
            height: 14px;
            animation-delay: 0.45s;
        }

        .title-meta {
            color: var(--text-dim);
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .title-links {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .title-links a {
            color: var(--amber);
            text-decoration: none;
        }

        .title-links a:hover {
            text-decoration: underline;
        }

        .terminal-chip {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 6px 10px;
            background: rgba(255, 179, 71, 0.05);
            color: var(--text-dim);
        }

        .terminal-chip strong {
            color: var(--amber);
            font-weight: 400;
        }

        .login-container {
            display: none;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 40px);
        }

        .login-box {
            width: 100%;
            max-width: 520px;
            padding: 26px;
        }

        .login-box p {
            color: var(--text-dim);
            margin-top: 8px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .prompt {
            color: var(--amber);
            margin-bottom: 8px;
            font-size: 12px;
        }

        .login-error {
            display: none;
            margin-bottom: 12px;
            border: 1px solid rgba(255, 107, 107, 0.55);
            background: rgba(255, 107, 107, 0.12);
            color: var(--err);
            border-radius: var(--radius);
            padding: 10px 12px;
            font-size: 12px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(8, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }

        .stat-card {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: linear-gradient(180deg, rgba(255, 179, 71, 0.05), transparent), var(--panel-2);
            padding: 12px;
            min-height: 92px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: border-color 120ms steps(2, end), transform 120ms steps(2, end);
        }

        .stat-card:hover {
            border-color: var(--border-strong);
            transform: translateY(-1px);
        }

        .stat-card .label {
            color: var(--text-dim);
            font-size: 11px;
            text-transform: uppercase;
            line-height: 1.5;
        }

        .stat-card .value {
            color: var(--amber);
            font-size: 22px;
            line-height: 1.2;
            text-shadow: 0 0 12px var(--amber-glow);
        }

        .stat-card.success .value {
            color: var(--ok);
            text-shadow: 0 0 10px rgba(87, 211, 140, 0.24);
        }

        .stat-card.warning .value {
            color: var(--warn);
            text-shadow: 0 0 10px rgba(255, 209, 102, 0.28);
        }

        .stat-card.error .value {
            color: var(--err);
            text-shadow: 0 0 10px rgba(255, 107, 107, 0.28);
        }

        .card {
            padding: 16px;
            margin-bottom: 16px;
        }

        .tabs {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 14px;
            padding: 4px;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: rgba(255, 179, 71, 0.04);
        }

        .tab {
            padding: 8px 14px;
            border: 1px solid transparent;
            border-radius: var(--radius);
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            font-family: inherit;
            font-size: 12px;
            text-transform: uppercase;
        }

        .tab:hover {
            border-color: rgba(255, 179, 71, 0.2);
            color: var(--text);
        }

        .tab.active {
            border-color: var(--border-strong);
            color: var(--amber);
            background: rgba(255, 179, 71, 0.1);
            box-shadow: 0 0 8px rgba(255, 179, 71, 0.2) inset;
        }

        .toolbar {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 14px;
        }

        .toolbar-spacer {
            flex: 1;
            min-width: 12px;
        }

        button,
        input,
        select,
        textarea {
            font-family: inherit;
            font-size: 12px;
        }

        select,
        input,
        textarea {
            width: auto;
            background: rgba(0, 0, 0, 0.28);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: var(--radius);
            padding: 10px 12px;
            min-height: 38px;
            outline: none;
        }

        input::placeholder,
        textarea::placeholder {
            color: #8d6a3b;
        }

        select:focus,
        input:focus,
        textarea:focus {
            border-color: var(--border-strong);
            box-shadow: 0 0 0 2px rgba(255, 179, 71, 0.18);
        }

        textarea {
            width: 100%;
            min-height: 90px;
            resize: vertical;
            line-height: 1.55;
        }

        .btn {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            min-height: 38px;
            padding: 10px 14px;
            color: var(--text);
            background: linear-gradient(180deg, rgba(255, 179, 71, 0.1), rgba(255, 179, 71, 0.03));
            cursor: pointer;
            transition: border-color 120ms steps(2, end), color 120ms steps(2, end), transform 120ms steps(2, end);
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .btn:hover {
            border-color: var(--border-strong);
            color: var(--amber);
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: wait;
            transform: none;
        }

        .btn-primary {
            background: linear-gradient(180deg, rgba(255, 179, 71, 0.22), rgba(255, 179, 71, 0.08));
            color: var(--amber);
            border-color: var(--border-strong);
        }

        .btn-secondary {
            background: rgba(255, 179, 71, 0.04);
            color: var(--text-dim);
        }

        .btn-success {
            border-color: rgba(87, 211, 140, 0.6);
            color: var(--ok);
            background: rgba(87, 211, 140, 0.08);
        }

        .btn-warning {
            border-color: rgba(255, 209, 102, 0.6);
            color: var(--warn);
            background: rgba(255, 209, 102, 0.08);
        }

        .btn-danger {
            border-color: rgba(255, 107, 107, 0.6);
            color: var(--err);
            background: rgba(255, 107, 107, 0.08);
        }

        .btn-sm {
            min-height: 32px;
            padding: 7px 10px;
            font-size: 11px;
        }

        .table-wrap {
            width: 100%;
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: rgba(0, 0, 0, 0.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 900px;
        }

        th,
        td {
            text-align: left;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 179, 71, 0.15);
            vertical-align: middle;
            white-space: nowrap;
            font-size: 12px;
        }

        th {
            color: var(--text-dim);
            text-transform: uppercase;
            font-size: 11px;
            letter-spacing: 0.08em;
            background: rgba(255, 179, 71, 0.06);
        }

        tbody tr:hover {
            background: rgba(255, 179, 71, 0.08);
        }

        .row-actions {
            display: inline-flex;
            gap: 6px;
            align-items: center;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 5px 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            background: rgba(255, 179, 71, 0.08);
        }

        .status-active {
            color: var(--ok);
            border-color: rgba(87, 211, 140, 0.6);
            background: rgba(87, 211, 140, 0.12);
        }

        .status-cooldown {
            color: var(--warn);
            border-color: rgba(255, 209, 102, 0.6);
            background: rgba(255, 209, 102, 0.12);
        }

        .status-invalid {
            color: var(--err);
            border-color: rgba(255, 107, 107, 0.65);
            background: rgba(255, 107, 107, 0.12);
        }

        .status-disabled {
            color: #a98456;
            border-color: rgba(169, 132, 86, 0.55);
            background: rgba(169, 132, 86, 0.1);
        }

        .usage-wrap {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            min-width: 180px;
        }

        .usage-meter {
            width: 120px;
            height: 12px;
            border: 1px solid var(--border);
            border-radius: 2px;
            background: repeating-linear-gradient(90deg, rgba(255, 179, 71, 0.1) 0 6px, rgba(0, 0, 0, 0.18) 6px 10px);
            overflow: hidden;
            position: relative;
        }

        .usage-meter-fill {
            height: 100%;
            background: repeating-linear-gradient(90deg, rgba(87, 211, 140, 0.95) 0 8px, rgba(87, 211, 140, 0.68) 8px 10px);
            box-shadow: 0 0 8px rgba(87, 211, 140, 0.35);
            transition: width 180ms steps(8, end);
        }

        .usage-meter-fill.warning {
            background: repeating-linear-gradient(90deg, rgba(255, 209, 102, 0.95) 0 8px, rgba(255, 209, 102, 0.68) 8px 10px);
            box-shadow: 0 0 8px rgba(255, 209, 102, 0.35);
        }

        .usage-meter-fill.danger {
            background: repeating-linear-gradient(90deg, rgba(255, 107, 107, 0.95) 0 8px, rgba(255, 107, 107, 0.68) 8px 10px);
            box-shadow: 0 0 8px rgba(255, 107, 107, 0.35);
        }

        .usage-text {
            font-size: 11px;
            color: var(--text-dim);
        }

        .empty-state {
            border: 1px dashed rgba(255, 179, 71, 0.35);
            border-radius: var(--radius);
            padding: 38px 18px;
            color: var(--text-dim);
            text-align: center;
            background: rgba(255, 179, 71, 0.03);
            font-size: 12px;
        }

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.68);
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            width: min(720px, 100%);
            max-height: 90vh;
            overflow-y: auto;
            padding: 18px;
        }

        .form-group {
            margin-bottom: 14px;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 12px;
        }

        .hotkeys {
            color: var(--text-dim);
            font-size: 11px;
            margin-top: 6px;
        }

        .kbd {
            border: 1px solid var(--border);
            border-radius: 2px;
            padding: 1px 5px;
            color: var(--amber);
            background: rgba(255, 179, 71, 0.08);
            font-size: 10px;
        }

        .toast-root {
            position: fixed;
            right: 14px;
            top: 14px;
            width: min(340px, calc(100vw - 28px));
            z-index: 1200;
            display: grid;
            gap: 8px;
        }

        .toast {
            border: 1px solid var(--border);
            border-left-width: 4px;
            border-radius: var(--radius);
            padding: 10px 12px;
            background: var(--panel);
            color: var(--text);
            font-size: 12px;
            box-shadow: var(--shadow);
            animation: toastIn 180ms steps(5, end);
        }

        .toast.info {
            border-left-color: var(--amber);
        }

        .toast.success {
            border-left-color: var(--ok);
            color: var(--ok);
        }

        .toast.error {
            border-left-color: var(--err);
            color: var(--err);
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        @keyframes bootFade {
            from {
                opacity: 0;
                transform: translateY(4px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes toastIn {
            from {
                opacity: 0;
                transform: translateX(8px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes signalPulse {
            0%,
            100% {
                opacity: 0.5;
            }

            50% {
                opacity: 1;
            }
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 179, 71, 0.35);
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 179, 71, 0.55);
        }

        @media (max-width: 1024px) {
            body {
                padding: 14px;
            }

            .window-titlebar {
                flex-direction: column;
                align-items: flex-start;
            }

            .title-right {
                width: 100%;
                display: flex;
                justify-content: flex-start;
            }

            .stats-grid {
                grid-template-columns: repeat(4, minmax(120px, 1fr));
            }
        }

        @media (max-width: 640px) {
            h1 {
                font-size: 20px;
            }

            .window-frame,
            .card,
            .login-box,
            .modal-content {
                padding: 12px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, minmax(120px, 1fr));
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .toolbar .btn,
            .toolbar select {
                width: 100%;
            }

            .toolbar-spacer {
                display: none;
            }

            .form-actions {
                justify-content: stretch;
            }

            .form-actions .btn {
                flex: 1;
            }

            .usage-wrap {
                min-width: 150px;
            }

            .usage-meter {
                width: 92px;
            }

            .title-links {
                width: 100%;
            }

            .title-links .terminal-chip {
                width: 100%;
                justify-content: flex-start;
            }
        }
    </style>
</head>

<body>
    <div class="toast-root" id="toastRoot" aria-live="polite" aria-atomic="false"></div>

    <div class="login-container" id="loginPage">
        <div class="login-box surface">
            <h1>Kiro-RS Console</h1>
            <p>[ AUTH REQUIRED ] 输入 API Key 登录管理控制台</p>
            <div class="prompt">$ AUTH TOKEN:</div>
            <div class="login-error" id="loginError">认证失败，请检查 API 密钥。</div>
            <label class="sr-only" for="apiKeyInput">API Key</label>
            <input type="password" id="apiKeyInput" placeholder="sk-..." onkeypress="if(event.key==='Enter') login()">
            <div class="form-actions" style="margin-top: 12px; justify-content: stretch;">
                <button class="btn btn-primary" onclick="login(this)" style="width:100%;">LOGIN</button>
            </div>
        </div>
    </div>

    <div class="container" id="mainPanel" style="display:none;">
        <div class="window-frame surface">
            <div class="window-titlebar">
                <div class="title-left">
                    <div class="signal" aria-hidden="true">
                        <span></span><span></span><span></span>
                    </div>
                    <div>
                        <h1>Kiro-RS Management Terminal</h1>
                        <div class="title-meta">[ POOL MODE ] Account Orchestration + Usage Monitor</div>
                    </div>
                </div>
                <div class="title-right title-links">
                    <span class="terminal-chip"><strong>HOTKEY</strong> <span class="kbd">Alt+R</span> Refresh <span class="kbd">Alt+A</span> Add</span>
                    <a class="terminal-chip" href="https://github.com/vagmr/kiro2api-rs" target="_blank" rel="noreferrer">
                        <strong>REPO</strong> github.com/vagmr/kiro2api-rs
                    </a>
                    <button class="btn btn-secondary btn-sm" onclick="logout()">LOGOUT</button>
                </div>
            </div>

            <div class="stats-grid" id="stats">
                <div class="stat-card">
                    <div class="label">Uptime</div>
                    <div class="value" id="stat-uptime">-</div>
                </div>
                <div class="stat-card success">
                    <div class="label">Active Accounts</div>
                    <div class="value" id="stat-active">-</div>
                </div>
                <div class="stat-card warning">
                    <div class="label">Cooldown</div>
                    <div class="value" id="stat-cooldown">-</div>
                </div>
                <div class="stat-card error">
                    <div class="label">Invalid</div>
                    <div class="value" id="stat-invalid">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Total Requests</div>
                    <div class="value" id="stat-requests">-</div>
                </div>
                <div class="stat-card error">
                    <div class="label">Total Errors</div>
                    <div class="value" id="stat-errors">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Input Tokens</div>
                    <div class="value" id="stat-input-tokens">-</div>
                </div>
                <div class="stat-card">
                    <div class="label">Output Tokens</div>
                    <div class="value" id="stat-output-tokens">-</div>
                </div>
            </div>
        </div>

        <div class="tabs" role="tablist" aria-label="management tabs">
            <button class="tab active" data-tab="accounts" onclick="switchTab('accounts')">Accounts</button>
            <button class="tab" data-tab="logs" onclick="switchTab('logs')">Request Logs</button>
        </div>

        <div class="card surface tab-content active" id="tab-accounts">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showAddModal()">+ Add Account</button>
                <button class="btn btn-warning" onclick="showImportModal()">Import JSON</button>
                <button class="btn btn-secondary" onclick="refreshAllUsage(this)">Refresh Quota</button>
                <div class="toolbar-spacer"></div>
                <select id="strategy" onchange="setStrategy(this.value)">
                    <option value="round-robin">Round Robin</option>
                    <option value="random">Random</option>
                    <option value="least-used">Least Used</option>
                </select>
                <button class="btn btn-secondary" onclick="refreshManual(this)">Refresh</button>
            </div>
            <div id="accounts-table"></div>
        </div>

        <div class="card surface tab-content" id="tab-logs" style="display:none;">
            <div class="toolbar">
                <button class="btn btn-secondary" onclick="loadLogs(this)">Refresh Logs</button>
            </div>
            <div id="logs-table"></div>
        </div>
    </div>

    <div class="modal" id="addModal" onclick="if(event.target===this) hideAddModal()">
        <div class="modal-content surface">
            <h3>[ Add Account ]</h3>
            <div class="form-group">
                <label>Display Name</label>
                <input type="text" id="acc-name" placeholder="账号备注名">
            </div>
            <div class="form-group">
                <label>Auth Method</label>
                <select id="acc-auth" onchange="toggleIdcFields()">
                    <option value="social">social</option>
                    <option value="idc">idc / builderId</option>
                </select>
            </div>
            <div class="form-group">
                <label>Refresh Token</label>
                <textarea id="acc-refresh" placeholder="粘贴 refreshToken"></textarea>
            </div>
            <div id="idc-fields" style="display:none;">
                <div class="form-group">
                    <label>Client ID</label>
                    <input type="text" id="acc-client-id" placeholder="clientId">
                </div>
                <div class="form-group">
                    <label>Client Secret</label>
                    <textarea id="acc-client-secret" placeholder="clientSecret"></textarea>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddModal()">Cancel</button>
                <button class="btn btn-primary" onclick="addAccount(this)">Create</button>
            </div>
        </div>
    </div>

    <div class="modal" id="importModal" onclick="if(event.target===this) hideImportModal()">
        <div class="modal-content surface">
            <h3>[ Import Kiro Credentials ]</h3>
            <div class="form-group">
                <label>Custom Name (Optional)</label>
                <input type="text" id="import-name" placeholder="留空则使用 email/label">
            </div>
            <div class="form-group">
                <label>Raw JSON</label>
                <textarea id="import-json" placeholder='粘贴完整 Kiro 凭证 JSON'></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideImportModal()">Cancel</button>
                <button class="btn btn-warning" onclick="importAccount(this)">Import</button>
            </div>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('kiro_api_key') || '';
        let usageCache = {};

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function showToast(message, type = 'info', duration = 2600) {
            const root = document.getElementById('toastRoot');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            root.appendChild(toast);
            window.setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(8px)';
                window.setTimeout(() => toast.remove(), 180);
            }, duration);
        }

        function setButtonLoading(button, loading, text = 'PROCESSING...') {
            if (!button) return;
            if (loading) {
                button.dataset.originalText = button.textContent;
                button.textContent = text;
                button.disabled = true;
            } else {
                button.textContent = button.dataset.originalText || button.textContent;
                button.disabled = false;
            }
        }

        async function withButtonLoading(button, text, task) {
            setButtonLoading(button, true, text);
            try {
                return await task();
            } finally {
                setButtonLoading(button, false);
            }
        }

        function extractErrorMessage(err) {
            if (!err) return '未知错误';
            const raw = String(err.message || err);
            try {
                const parsed = JSON.parse(raw);
                return parsed.error || raw;
            } catch {
                const trimmed = raw.replace(/^Error:\s*/, '').trim();
                return trimmed || '请求失败';
            }
        }

        async function checkAuth() {
            if (!apiKey) return false;
            try {
                const res = await fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                return res.ok;
            } catch {
                return false;
            }
        }

        async function login(button) {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                showToast('请输入 API 密钥', 'error');
                return;
            }

            await withButtonLoading(button, 'VERIFYING...', async () => {
                try {
                    const res = await fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + key } });
                    if (!res.ok) {
                        document.getElementById('loginError').style.display = 'block';
                        showToast('认证失败，请检查密钥', 'error');
                        return;
                    }
                    apiKey = key;
                    localStorage.setItem('kiro_api_key', key);
                    document.getElementById('loginError').style.display = 'none';
                    showMainPanel();
                    showToast('登录成功', 'success');
                } catch {
                    document.getElementById('loginError').style.display = 'block';
                    showToast('网络异常，认证失败', 'error');
                }
            });
        }

        function logout() {
            apiKey = '';
            localStorage.removeItem('kiro_api_key');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainPanel').style.display = 'none';
            showToast('已退出登录', 'info');
        }

        function showMainPanel() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            refresh();
        }

        async function fetchApi(url, options = {}) {
            const res = await fetch(url, {
                ...options,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + apiKey,
                    ...options.headers
                }
            });

            if (res.status === 401) {
                logout();
                throw new Error('认证失败，请重新登录');
            }

            if (!res.ok && res.status !== 204) {
                throw new Error(await res.text() || res.statusText);
            }

            return res.status === 204 ? null : res.json();
        }

        function formatUptime(secs) {
            const h = Math.floor(secs / 3600);
            const m = Math.floor((secs % 3600) / 60);
            const s = secs % 60;
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toString();
        }

        function statusLabel(status) {
            const key = String(status || '').toLowerCase();
            if (key === 'active') return '[ACTIVE]';
            if (key === 'cooldown') return '[COOLDOWN]';
            if (key === 'invalid') return '[INVALID]';
            if (key === 'disabled') return '[DISABLED]';
            return `[${key || 'UNKNOWN'}]`;
        }

        async function loadStatus() {
            try {
                const data = await fetchApi('/api/status');
                document.getElementById('stat-uptime').textContent = formatUptime(data.uptime_secs);
                document.getElementById('stat-active').textContent = data.pool.active;
                document.getElementById('stat-cooldown').textContent = data.pool.cooldown;
                document.getElementById('stat-invalid').textContent = data.pool.invalid;
                document.getElementById('stat-requests').textContent = formatNumber(data.pool.total_requests);
                document.getElementById('stat-errors').textContent = data.pool.total_errors;
            } catch (e) {
                console.error(e);
            }

            try {
                const stats = await fetchApi('/api/logs/stats');
                document.getElementById('stat-input-tokens').textContent = formatNumber(stats.total_input_tokens || 0);
                document.getElementById('stat-output-tokens').textContent = formatNumber(stats.total_output_tokens || 0);
            } catch (e) {
                console.error(e);
            }
        }

        async function loadAccounts() {
            try {
                const accounts = await fetchApi('/api/accounts');
                const container = document.getElementById('accounts-table');

                if (accounts.length === 0) {
                    container.innerHTML = '<div class="empty-state">[ EMPTY ] 暂无账号，点击上方按钮添加或导入。</div>';
                    return;
                }

                container.innerHTML = `<div class="table-wrap"><table>
                    <thead><tr><th>Name</th><th>Status</th><th>Quota</th><th>Requests</th><th>Errors</th><th>Last Used</th><th>Actions</th></tr></thead>
                    <tbody>${accounts.map(a => {
                        const usage = usageCache[a.id];
                        let usageHtml = '<span class="usage-text">N/A</span>';
                        if (usage && usage.usage_limit > 0) {
                            const pct = Math.max(0, Math.min(100, usage.available / usage.usage_limit * 100));
                            const cls = pct < 10 ? 'danger' : pct < 30 ? 'warning' : '';
                            usageHtml = `<div class="usage-wrap">
                                <div class="usage-meter"><div class="usage-meter-fill ${cls}" style="width:${pct}%"></div></div>
                                <span class="usage-text">${usage.available.toFixed(1)}</span>
                            </div>`;
                        }

                        return `<tr>
                            <td>${escapeHtml(a.name)}</td>
                            <td><span class="status-badge status-${escapeHtml(a.status)}">${statusLabel(a.status)}</span></td>
                            <td>${usageHtml}</td>
                            <td>${a.request_count}</td>
                            <td>${a.error_count}</td>
                            <td>${a.last_used_at ? new Date(a.last_used_at).toLocaleString() : '-'}</td>
                            <td>
                                <div class="row-actions">
                                    <button class="btn btn-secondary btn-sm" onclick="refreshUsage('${a.id}', this)" title="刷新配额">REFRESH</button>
                                    ${a.status === 'disabled'
                                        ? `<button class="btn btn-success btn-sm" onclick="enableAccount('${a.id}', this)">ENABLE</button>`
                                        : `<button class="btn btn-secondary btn-sm" onclick="disableAccount('${a.id}', this)">DISABLE</button>`}
                                    <button class="btn btn-danger btn-sm" onclick="removeAccount('${a.id}', this)">DELETE</button>
                                </div>
                            </td>
                        </tr>`;
                    }).join('')}</tbody>
                </table></div>`;
            } catch (e) {
                console.error(e);
                showToast('加载账号失败', 'error');
            }
        }

        async function loadLogs(button) {
            const run = async () => {
                try {
                    const logs = await fetchApi('/api/logs');
                    const container = document.getElementById('logs-table');

                    if (!logs || logs.length === 0) {
                        container.innerHTML = '<div class="empty-state">[ EMPTY ] 暂无请求记录。</div>';
                        return;
                    }

                    container.innerHTML = `<div class="table-wrap"><table>
                        <thead><tr><th>Time</th><th>Account</th><th>Model</th><th>Input</th><th>Output</th><th>Duration</th><th>Status</th></tr></thead>
                        <tbody>${logs.map(l => `<tr>
                            <td>${new Date(l.timestamp).toLocaleString()}</td>
                            <td>${escapeHtml(l.account_name)}</td>
                            <td>${escapeHtml(l.model)}</td>
                            <td>${l.input_tokens}</td>
                            <td>${l.output_tokens < 0 ? '-' : l.output_tokens}</td>
                            <td>${l.duration_ms}ms</td>
                            <td>${l.success
                                ? '<span class="status-badge status-active">[SUCCESS]</span>'
                                : `<span class="status-badge status-invalid" title="${escapeHtml(l.error || '')}">[FAILED]</span>`}</td>
                        </tr>`).join('')}</tbody>
                    </table></div>`;
                } catch (e) {
                    console.error(e);
                    showToast('加载日志失败', 'error');
                }
            };

            if (button) return withButtonLoading(button, 'LOADING...', run);
            return run();
        }

        async function loadStrategy() {
            try {
                const data = await fetchApi('/api/strategy');
                document.getElementById('strategy').value = data.strategy;
            } catch (e) {
                console.error(e);
            }
        }

        async function setStrategy(value) {
            try {
                await fetchApi('/api/strategy', { method: 'POST', body: JSON.stringify({ strategy: value }) });
                showToast('策略已更新', 'success');
            } catch (e) {
                console.error(e);
                showToast(`设置失败: ${extractErrorMessage(e)}`, 'error');
            }
        }

        async function refreshUsage(id, button) {
            await withButtonLoading(button, 'SYNC...', async () => {
                try {
                    const usage = await fetchApi(`/api/accounts/${id}/usage/refresh`, { method: 'POST' });
                    usageCache[id] = usage;
                    await loadAccounts();
                    showToast('配额已刷新', 'success');
                } catch (e) {
                    showToast(`刷新配额失败: ${extractErrorMessage(e)}`, 'error');
                }
            });
        }

        async function refreshAllUsage(button) {
            await withButtonLoading(button, 'SYNC ALL...', async () => {
                try {
                    const results = await fetchApi('/api/usage/refresh', { method: 'POST' });
                    results.forEach(r => {
                        if (r.success) usageCache[r.id] = r.usage;
                    });
                    await loadAccounts();
                    showToast('全部配额刷新完成', 'success');
                } catch (e) {
                    showToast(`刷新失败: ${extractErrorMessage(e)}`, 'error');
                }
            });
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => {
                c.style.display = 'none';
                c.classList.remove('active');
            });

            const target = document.querySelector(`.tab[data-tab="${tab}"]`);
            if (target) target.classList.add('active');

            const content = document.getElementById('tab-' + tab);
            if (content) {
                content.style.display = 'block';
                content.classList.add('active');
            }

            if (tab === 'logs') loadLogs();
        }

        function showAddModal() {
            document.getElementById('addModal').classList.add('show');
        }

        function hideAddModal() {
            document.getElementById('addModal').classList.remove('show');
        }

        function showImportModal() {
            document.getElementById('importModal').classList.add('show');
        }

        function hideImportModal() {
            document.getElementById('importModal').classList.remove('show');
        }

        function toggleIdcFields() {
            document.getElementById('idc-fields').style.display =
                document.getElementById('acc-auth').value === 'idc' ? 'block' : 'none';
        }

        async function addAccount(button) {
            const data = {
                name: document.getElementById('acc-name').value || '未命名账号',
                auth_method: document.getElementById('acc-auth').value,
                refresh_token: document.getElementById('acc-refresh').value,
                client_id: document.getElementById('acc-client-id').value || null,
                client_secret: document.getElementById('acc-client-secret').value || null,
            };

            if (!data.refresh_token) {
                showToast('请填写 Refresh Token', 'error');
                return;
            }

            await withButtonLoading(button, 'CREATING...', async () => {
                try {
                    await fetchApi('/api/accounts', { method: 'POST', body: JSON.stringify(data) });
                    hideAddModal();
                    await refresh();
                    showToast('账号添加成功', 'success');
                } catch (e) {
                    showToast(`添加失败: ${extractErrorMessage(e)}`, 'error');
                }
            });
        }

        async function importAccount(button) {
            const rawJson = document.getElementById('import-json').value.trim();
            const name = document.getElementById('import-name').value.trim() || null;
            if (!rawJson) {
                showToast('请粘贴 JSON 凭证', 'error');
                return;
            }

            try {
                JSON.parse(rawJson);
            } catch {
                showToast('JSON 格式错误', 'error');
                return;
            }

            await withButtonLoading(button, 'IMPORTING...', async () => {
                try {
                    await fetchApi('/api/accounts/import', { method: 'POST', body: JSON.stringify({ raw_json: rawJson, name }) });
                    hideImportModal();
                    await refresh();
                    showToast('导入成功', 'success');
                } catch (e) {
                    showToast(`导入失败: ${extractErrorMessage(e)}`, 'error');
                }
            });
        }

        async function removeAccount(id, button) {
            if (!confirm('确定删除此账号？')) return;
            await withButtonLoading(button, 'DELETING...', async () => {
                try {
                    await fetchApi(`/api/accounts/${id}`, { method: 'DELETE' });
                    await refresh();
                    showToast('账号已删除', 'success');
                } catch (e) {
                    showToast(`删除失败: ${extractErrorMessage(e)}`, 'error');
                }
            });
        }

        async function enableAccount(id, button) {
            await withButtonLoading(button, 'ENABLING...', async () => {
                try {
                    await fetchApi(`/api/accounts/${id}/enable`, { method: 'POST' });
                    await refresh();
                    showToast('账号已启用', 'success');
                } catch (e) {
                    showToast(`启用失败: ${extractErrorMessage(e)}`, 'error');
                }
            });
        }

        async function disableAccount(id, button) {
            await withButtonLoading(button, 'DISABLING...', async () => {
                try {
                    await fetchApi(`/api/accounts/${id}/disable`, { method: 'POST' });
                    await refresh();
                    showToast('账号已禁用', 'info');
                } catch (e) {
                    showToast(`禁用失败: ${extractErrorMessage(e)}`, 'error');
                }
            });
        }

        async function loadUsageCache() {
            try {
                usageCache = await fetchApi('/api/usage');
            } catch (e) {
                console.error('加载配额缓存失败:', e);
                usageCache = {};
            }
        }

        async function refresh() {
            await loadStatus();
            await loadUsageCache();
            await loadAccounts();
            await loadStrategy();
        }

        async function refreshManual(button) {
            await withButtonLoading(button, 'REFRESHING...', async () => {
                await refresh();
                showToast('数据已刷新', 'success');
            });
        }

        document.addEventListener('keydown', (e) => {
            const activeTag = document.activeElement && document.activeElement.tagName;
            const inInput = ['INPUT', 'TEXTAREA', 'SELECT'].includes(activeTag);

            if (e.key === 'Escape') {
                hideAddModal();
                hideImportModal();
                return;
            }

            if (!e.altKey) return;

            if (e.key.toLowerCase() === 'r') {
                e.preventDefault();
                if (apiKey && !inInput) refresh().then(() => showToast('快捷刷新完成', 'success'));
            }

            if (e.key.toLowerCase() === 'a') {
                e.preventDefault();
                if (apiKey) showAddModal();
            }
        });

        (async () => {
            if (await checkAuth()) {
                showMainPanel();
            } else {
                document.getElementById('loginPage').style.display = 'flex';
            }
        })();

        setInterval(() => {
            if (apiKey) loadStatus();
        }, 5000);
    </script>
</body>

</html>
