<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kiro-RS ç®¡ç†é¢æ¿</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #e4e4e7;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #60a5fa; margin-bottom: 24px; font-size: 28px; }
        h2 { color: #a5b4fc; margin-bottom: 16px; font-size: 18px; }
        
        /* ç™»å½•é¡µé¢æ ·å¼ */
        .login-container {
            display: none; align-items: center; justify-content: center;
            min-height: calc(100vh - 40px);
        }
        .login-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 40px;
            width: 100%; max-width: 400px;
            text-align: center;
        }
        .login-box h1 { margin-bottom: 8px; }
        .login-box p { color: #9ca3af; margin-bottom: 32px; }
        .login-box input {
            width: 100%; padding: 14px 18px; margin-bottom: 16px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px; color: #e4e4e7; font-size: 14px;
        }
        .login-box input:focus { outline: none; border-color: #60a5fa; }
        .login-box .btn { width: 100%; padding: 14px; }
        .login-error { color: #f87171; margin-bottom: 16px; display: none; }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }
        .stat-card .value { font-size: 28px; font-weight: 700; color: #60a5fa; }
        .stat-card .label { font-size: 11px; color: #9ca3af; margin-top: 4px; }
        .stat-card.success .value { color: #34d399; }
        .stat-card.warning .value { color: #fbbf24; }
        .stat-card.error .value { color: #f87171; }
        
        .card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .toolbar { display: flex; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
        
        select, input, textarea {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            padding: 8px 12px;
            color: #e4e4e7;
            font-size: 13px;
        }
        select:focus, input:focus, textarea:focus { outline: none; border-color: #60a5fa; }
</style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="loginPage">
        <div class="login-box">
            <h1>ğŸ” Kiro-RS</h1>
            <p>è¯·è¾“å…¥ API å¯†é’¥ç™»å½•ç®¡ç†é¢æ¿</p>
            <div class="login-error" id="loginError">å¯†é’¥é”™è¯¯ï¼Œè¯·é‡è¯•</div>
            <input type="password" id="apiKeyInput" placeholder="API å¯†é’¥" onkeypress="if(event.key==='Enter')login()">
            <button class="btn btn-primary" onclick="login()">ç™»å½•</button>
        </div>
    </div>

    <!-- ä¸»é¢æ¿ -->
    <div class="container" id="mainPanel" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h1>ğŸš€ Kiro-RS ç®¡ç†é¢æ¿</h1>
            <button class="btn btn-secondary btn-sm" onclick="logout()">é€€å‡ºç™»å½•</button>
        </div>
        
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid" id="stats">
            <div class="stat-card"><div class="value" id="stat-uptime">-</div><div class="label">è¿è¡Œæ—¶é—´</div></div>
            <div class="stat-card success"><div class="value" id="stat-active">-</div><div class="label">æ´»è·ƒè´¦å·</div></div>
            <div class="stat-card warning"><div class="value" id="stat-cooldown">-</div><div class="label">å†·å´ä¸­</div></div>
            <div class="stat-card error"><div class="value" id="stat-invalid">-</div><div class="label">å·²å¤±æ•ˆ</div></div>
            <div class="stat-card"><div class="value" id="stat-requests">-</div><div class="label">æ€»è¯·æ±‚</div></div>
            <div class="stat-card error"><div class="value" id="stat-errors">-</div><div class="label">æ€»é”™è¯¯</div></div>
            <div class="stat-card"><div class="value" id="stat-input-tokens">-</div><div class="label">è¾“å…¥Tokens</div></div>
            <div class="stat-card"><div class="value" id="stat-output-tokens">-</div><div class="label">è¾“å‡ºTokens</div></div>
        </div>

        <!-- æ ‡ç­¾é¡µ -->
        <div class="tabs">
            <div class="tab active" onclick="switchTab('accounts')">è´¦å·ç®¡ç†</div>
            <div class="tab" onclick="switchTab('logs')">è¯·æ±‚è®°å½•</div>
        </div>

        <!-- è´¦å·ç®¡ç† -->
        <div class="card tab-content active" id="tab-accounts">
            <div class="toolbar">
                <button class="btn btn-primary" onclick="showAddModal()">+ æ·»åŠ è´¦å·</button>
                <button class="btn btn-warning" onclick="showImportModal()">ğŸ“¥ å¯¼å…¥</button>
                <button class="btn btn-secondary" onclick="refreshAllUsage()">ğŸ”„ åˆ·æ–°é…é¢</button>
                <select id="strategy" onchange="setStrategy(this.value)">
                    <option value="round-robin">è½®è¯¢ç­–ç•¥</option>
                    <option value="random">éšæœºç­–ç•¥</option>
                    <option value="least-used">æœ€å°‘ä½¿ç”¨</option>
                </select>
                <button class="btn btn-secondary" onclick="refresh()">åˆ·æ–°</button>
            </div>
            <div id="accounts-table"></div>
        </div>

        <!-- è¯·æ±‚è®°å½• -->
        <div class="card tab-content" id="tab-logs" style="display:none;">
            <div class="toolbar">
                <button class="btn btn-secondary" onclick="loadLogs()">åˆ·æ–°è®°å½•</button>
            </div>
            <div id="logs-table"></div>
        </div>
    </div>

    <!-- æ·»åŠ è´¦å·å¼¹çª— -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <h3>æ·»åŠ è´¦å·</h3>
            <div class="form-group">
                <label>åç§°</label>
                <input type="text" id="acc-name" placeholder="è´¦å·å¤‡æ³¨å">
            </div>
            <div class="form-group">
                <label>è®¤è¯æ–¹å¼</label>
                <select id="acc-auth" onchange="toggleIdcFields()">
                    <option value="social">Social</option>
                    <option value="idc">IdC / BuilderId</option>
                </select>
            </div>
            <div class="form-group">
                <label>Refresh Token</label>
                <textarea id="acc-refresh" placeholder="ç²˜è´´ refreshToken"></textarea>
            </div>
            <div id="idc-fields" style="display:none;">
                <div class="form-group">
                    <label>Client ID</label>
                    <input type="text" id="acc-client-id">
                </div>
                <div class="form-group">
                    <label>Client Secret</label>
                    <textarea id="acc-client-secret"></textarea>
                </div>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideAddModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="addAccount()">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- å¯¼å…¥è´¦å·å¼¹çª— -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <h3>ğŸ“¥ å¯¼å…¥ Kiro å‡­è¯</h3>
            <div class="form-group">
                <label>è‡ªå®šä¹‰åç§° (å¯é€‰)</label>
                <input type="text" id="import-name" placeholder="ç•™ç©ºåˆ™ä½¿ç”¨ email/label">
            </div>
            <div class="form-group">
                <label>Kiro åŸå§‹ JSON</label>
                <textarea id="import-json" class="large" placeholder='ç²˜è´´å®Œæ•´çš„ Kiro å‡­è¯ JSON'></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-secondary" onclick="hideImportModal()">å–æ¶ˆ</button>
                <button class="btn btn-warning" onclick="importAccount()">å¯¼å…¥</button>
            </div>
        </div>
    </div>

    <style>
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
        }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #10b981; color: white; }
        .btn-success:hover { background: #059669; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #e4e4e7; }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        
        .tabs { display: flex; gap: 0; margin-bottom: 0; }
        .tab {
            padding: 12px 24px; cursor: pointer; color: #9ca3af;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.1);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            margin-right: 4px;
        }
        .tab:hover { color: #e4e4e7; background: rgba(255,255,255,0.05); }
        .tab.active { color: #60a5fa; background: rgba(255,255,255,0.05); border-bottom: 2px solid #60a5fa; }
        
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th, td { text-align: left; padding: 10px 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        th { color: #9ca3af; font-weight: 500; font-size: 11px; text-transform: uppercase; }
        
        .status-badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
        .status-active { background: rgba(52,211,153,0.2); color: #34d399; }
        .status-cooldown { background: rgba(251,191,36,0.2); color: #fbbf24; }
        .status-invalid { background: rgba(248,113,113,0.2); color: #f87171; }
        .status-disabled { background: rgba(156,163,175,0.2); color: #9ca3af; }
        
        .usage-bar { width: 100px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .usage-bar-fill { height: 100%; background: #34d399; transition: width 0.3s; }
        .usage-bar-fill.warning { background: #fbbf24; }
        .usage-bar-fill.danger { background: #f87171; }
        
        .modal {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7); align-items: center; justify-content: center; z-index: 1000;
        }
        .modal.show { display: flex; }
        .modal-content {
            background: #1e293b; border-radius: 16px; padding: 28px;
            width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto;
        }
        .modal-content h3 { margin-bottom: 20px; color: #60a5fa; }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 6px; color: #9ca3af; font-size: 13px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; }
        .form-group textarea { min-height: 70px; resize: vertical; font-family: monospace; font-size: 12px; }
        .form-group textarea.large { min-height: 120px; }
        .form-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px; }
        .empty-state { text-align: center; padding: 40px; color: #6b7280; }
    </style>

    <script>
        let apiKey = localStorage.getItem('kiro_api_key') || '';
        let usageCache = {};

        async function checkAuth() {
            if (!apiKey) return false;
            try {
                const res = await fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + apiKey } });
                return res.ok;
            } catch { return false; }
        }

        async function login() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) { alert('è¯·è¾“å…¥ API å¯†é’¥'); return; }
            try {
                const res = await fetch('/api/status', { headers: { 'Authorization': 'Bearer ' + key } });
                if (res.ok) {
                    apiKey = key;
                    localStorage.setItem('kiro_api_key', key);
                    showMainPanel();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                }
            } catch { document.getElementById('loginError').style.display = 'block'; }
        }

        function logout() {
            apiKey = '';
            localStorage.removeItem('kiro_api_key');
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainPanel').style.display = 'none';
        }

        function showMainPanel() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPanel').style.display = 'block';
            refresh();
        }

        async function fetchApi(url, options = {}) {
            const res = await fetch(url, {
                ...options,
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + apiKey, ...options.headers }
            });
            if (res.status === 401) { logout(); throw new Error('è®¤è¯å¤±è´¥'); }
            if (!res.ok && res.status !== 204) throw new Error(await res.text() || res.statusText);
            return res.status === 204 ? null : res.json();
        }

        function formatUptime(secs) {
            const h = Math.floor(secs / 3600), m = Math.floor((secs % 3600) / 60), s = secs % 60;
            if (h > 0) return `${h}h ${m}m`;
            if (m > 0) return `${m}m ${s}s`;
            return `${s}s`;
        }

        function formatNumber(n) {
            if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
            return n.toString();
        }

        async function loadStatus() {
            try {
                const data = await fetchApi('/api/status');
                document.getElementById('stat-uptime').textContent = formatUptime(data.uptime_secs);
                document.getElementById('stat-active').textContent = data.pool.active;
                document.getElementById('stat-cooldown').textContent = data.pool.cooldown;
                document.getElementById('stat-invalid').textContent = data.pool.invalid;
                document.getElementById('stat-requests').textContent = formatNumber(data.pool.total_requests);
                document.getElementById('stat-errors').textContent = data.pool.total_errors;
            } catch (e) { console.error(e); }
            
            // åŠ è½½è¯·æ±‚ç»Ÿè®¡
            try {
                const stats = await fetchApi('/api/logs/stats');
                document.getElementById('stat-input-tokens').textContent = formatNumber(stats.total_input_tokens || 0);
                document.getElementById('stat-output-tokens').textContent = formatNumber(stats.total_output_tokens || 0);
            } catch (e) { console.error(e); }
        }

        async function loadAccounts() {
            try {
                const accounts = await fetchApi('/api/accounts');
                const container = document.getElementById('accounts-table');
                
                if (accounts.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— è´¦å·ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ æˆ–å¯¼å…¥</p></div>';
                    return;
                }

                container.innerHTML = `<table>
                    <thead><tr><th>åç§°</th><th>çŠ¶æ€</th><th>é…é¢</th><th>è¯·æ±‚</th><th>é”™è¯¯</th><th>æœ€åä½¿ç”¨</th><th>æ“ä½œ</th></tr></thead>
                    <tbody>${accounts.map(a => {
                        const usage = usageCache[a.id];
                        let usageHtml = '<span style="color:#6b7280">æœªè·å–</span>';
                        if (usage) {
                            const pct = usage.usage_limit > 0 ? (usage.available / usage.usage_limit * 100) : 0;
                            const cls = pct < 10 ? 'danger' : pct < 30 ? 'warning' : '';
                            usageHtml = `<div style="display:flex;align-items:center;gap:8px;">
                                <div class="usage-bar"><div class="usage-bar-fill ${cls}" style="width:${pct}%"></div></div>
                                <span style="font-size:11px">${usage.available.toFixed(1)}/${usage.usage_limit.toFixed(0)}</span>
                            </div>`;
                        }
                        return `<tr>
                            <td>${a.name}</td>
                            <td><span class="status-badge status-${a.status}">${a.status}</span></td>
                            <td>${usageHtml}</td>
                            <td>${a.request_count}</td>
                            <td>${a.error_count}</td>
                            <td>${a.last_used_at ? new Date(a.last_used_at).toLocaleString() : '-'}</td>
                            <td>
                                <button class="btn btn-secondary btn-sm" onclick="refreshUsage('${a.id}')" title="åˆ·æ–°é…é¢">ğŸ”„</button>
                                ${a.status === 'disabled' 
                                    ? `<button class="btn btn-success btn-sm" onclick="enableAccount('${a.id}')">å¯ç”¨</button>`
                                    : `<button class="btn btn-secondary btn-sm" onclick="disableAccount('${a.id}')">ç¦ç”¨</button>`}
                                <button class="btn btn-danger btn-sm" onclick="removeAccount('${a.id}')">åˆ é™¤</button>
                            </td>
                        </tr>`;
                    }).join('')}</tbody>
                </table>`;
            } catch (e) { console.error(e); }
        }

        async function loadLogs() {
            try {
                const logs = await fetchApi('/api/logs');
                const container = document.getElementById('logs-table');
                
                if (!logs || logs.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>æš‚æ— è¯·æ±‚è®°å½•</p></div>';
                    return;
                }

                container.innerHTML = `<table>
                    <thead><tr><th>æ—¶é—´</th><th>è´¦å·</th><th>æ¨¡å‹</th><th>è¾“å…¥</th><th>è¾“å‡º</th><th>è€—æ—¶</th><th>çŠ¶æ€</th></tr></thead>
                    <tbody>${logs.map(l => `<tr>
                        <td>${new Date(l.timestamp).toLocaleString()}</td>
                        <td>${l.account_name}</td>
                        <td style="font-size:11px">${l.model}</td>
                        <td>${l.input_tokens}</td>
                        <td>${l.output_tokens}</td>
                        <td>${l.duration_ms}ms</td>
                        <td>${l.success 
                            ? '<span class="status-badge status-active">æˆåŠŸ</span>' 
                            : `<span class="status-badge status-invalid" title="${l.error || ''}">å¤±è´¥</span>`}</td>
                    </tr>`).join('')}</tbody>
                </table>`;
            } catch (e) { console.error(e); }
        }

        async function loadStrategy() {
            try {
                const data = await fetchApi('/api/strategy');
                document.getElementById('strategy').value = data.strategy;
            } catch (e) { console.error(e); }
        }

        async function setStrategy(value) {
            try { await fetchApi('/api/strategy', { method: 'POST', body: JSON.stringify({ strategy: value }) }); }
            catch (e) { alert('è®¾ç½®å¤±è´¥: ' + e.message); }
        }

        async function refreshUsage(id) {
            try {
                const usage = await fetchApi(`/api/accounts/${id}/usage/refresh`, { method: 'POST' });
                usageCache[id] = usage;
                loadAccounts();
            } catch (e) { alert('åˆ·æ–°é…é¢å¤±è´¥: ' + e.message); }
        }

        async function refreshAllUsage() {
            try {
                const results = await fetchApi('/api/usage/refresh', { method: 'POST' });
                results.forEach(r => { if (r.success) usageCache[r.id] = r.usage; });
                loadAccounts();
                alert('é…é¢åˆ·æ–°å®Œæˆ');
            } catch (e) { alert('åˆ·æ–°å¤±è´¥: ' + e.message); }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => { c.style.display = 'none'; c.classList.remove('active'); });
            document.querySelector(`.tab[onclick*="${tab}"]`).classList.add('active');
            document.getElementById('tab-' + tab).style.display = 'block';
            if (tab === 'logs') loadLogs();
        }

        function showAddModal() { document.getElementById('addModal').classList.add('show'); }
        function hideAddModal() { document.getElementById('addModal').classList.remove('show'); }
        function showImportModal() { document.getElementById('importModal').classList.add('show'); }
        function hideImportModal() { document.getElementById('importModal').classList.remove('show'); }
        function toggleIdcFields() {
            document.getElementById('idc-fields').style.display = document.getElementById('acc-auth').value === 'idc' ? 'block' : 'none';
        }

        async function addAccount() {
            const data = {
                name: document.getElementById('acc-name').value || 'æœªå‘½åè´¦å·',
                auth_method: document.getElementById('acc-auth').value,
                refresh_token: document.getElementById('acc-refresh').value,
                client_id: document.getElementById('acc-client-id').value || null,
                client_secret: document.getElementById('acc-client-secret').value || null,
            };
            if (!data.refresh_token) { alert('è¯·å¡«å†™ Refresh Token'); return; }
            try {
                await fetchApi('/api/accounts', { method: 'POST', body: JSON.stringify(data) });
                hideAddModal(); refresh();
            } catch (e) { alert('æ·»åŠ å¤±è´¥: ' + e.message); }
        }

        async function importAccount() {
            const rawJson = document.getElementById('import-json').value.trim();
            const name = document.getElementById('import-name').value.trim() || null;
            if (!rawJson) { alert('è¯·ç²˜è´´ JSON å‡­è¯'); return; }
            try { JSON.parse(rawJson); } catch { alert('JSON æ ¼å¼é”™è¯¯'); return; }
            try {
                await fetchApi('/api/accounts/import', { method: 'POST', body: JSON.stringify({ raw_json: rawJson, name }) });
                hideImportModal(); refresh(); alert('å¯¼å…¥æˆåŠŸï¼');
            } catch (e) { alert('å¯¼å…¥å¤±è´¥: ' + e.message); }
        }

        async function removeAccount(id) {
            if (!confirm('ç¡®å®šåˆ é™¤æ­¤è´¦å·ï¼Ÿ')) return;
            try { await fetchApi(`/api/accounts/${id}`, { method: 'DELETE' }); refresh(); }
            catch (e) { alert('åˆ é™¤å¤±è´¥: ' + e.message); }
        }

        async function enableAccount(id) {
            try { await fetchApi(`/api/accounts/${id}/enable`, { method: 'POST' }); refresh(); }
            catch (e) { alert('å¯ç”¨å¤±è´¥: ' + e.message); }
        }

        async function disableAccount(id) {
            try { await fetchApi(`/api/accounts/${id}/disable`, { method: 'POST' }); refresh(); }
            catch (e) { alert('ç¦ç”¨å¤±è´¥: ' + e.message); }
        }

        function refresh() { loadStatus(); loadAccounts(); loadStrategy(); }

        (async () => {
            if (await checkAuth()) { showMainPanel(); }
            else { document.getElementById('loginPage').style.display = 'flex'; }
        })();
        setInterval(() => { if (apiKey) loadStatus(); }, 5000);
    </script>
</body>
</html>
